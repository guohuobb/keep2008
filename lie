const BOT_TOKEN = "";  // Telegram Bot Token
const CHAT_ID   = "";  // Telegram Chat ID

// Telegram æ¨é€
async function tg(msg) {
    if (!BOT_TOKEN || !CHAT_ID) return;
    await fetch("https://api.telegram.org/bot" + BOT_TOKEN + "/sendMessage", {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify({ chat_id: CHAT_ID, text: msg })
    });
}

// KV è¯»å–
async function loadList() {
    const raw = await KEEP.get("list");
    return raw ? JSON.parse(raw) : [];
}

// KV ä¿å­˜
async function saveList(list) {
    await KEEP.put("list", JSON.stringify(list));
}

/* ===========================
      ç®¡ç†åå° (å«å¤œé—´æ¨¡å¼)
   =========================== */
const adminHTML =
"<!DOCTYPE html><html><head><meta charset='utf-8'><title>KeepURL ç®¡ç†</title>" +
"<meta name='viewport' content='width=device-width, initial-scale=1'>" +
"<style>" +
"body{font-family:sans-serif;padding:20px;transition:0.3s;} " +
".dark{background:#111;color:#ddd;} " +
"input,button{padding:6px;margin:4px 0;border-radius:6px;} " +
"input{width:90%;} " +
".item{border:1px solid #666;padding:10px;margin:6px 0;border-radius:6px;} " +
"</style></head><body>" +
"<button onclick='toggleDark()'>ğŸŒ™ å¤œé—´æ¨¡å¼</button>" +
"<h2>ğŸŸ¢ KeepURL ç®¡ç†åå°</h2>" +
"<p><a href='/status' target='_blank'>æŸ¥çœ‹å…¬å¼€çŠ¶æ€é¡µ</a></p>" +

"<h3>æ·»åŠ ç›‘æ§</h3>" +
"<input id='name' placeholder='åç§°'><br>" +
"<input id='url' placeholder='https://example.com'><br>" +
"<button onclick='add()'>æ·»åŠ </button>" +

"<h3>ç›‘æ§åˆ—è¡¨</h3>" +
"<div id='list'></div>" +

"<script>" +
// å¤œé—´æ¨¡å¼
"if(localStorage.dark=='1') document.body.classList.add('dark');" +
"function toggleDark(){document.body.classList.toggle('dark');localStorage.dark=document.body.classList.contains('dark')?'1':'0';}" +

"async function load(){var r=await fetch('/api/list'); var j=await r.json(); var box=document.getElementById('list'); box.innerHTML='';" +
"j.forEach(function(x,i){ box.innerHTML += '<div class=\"item\"><b>'+x.name+'</b><br><small>'+x.url+'</small><br><button onclick=\"del('+i+')\">åˆ é™¤</button></div>'; });}" +

"async function add(){var name=document.getElementById('name').value.trim(); var url=document.getElementById('url').value.trim(); if(!name||!url){alert('è¯·è¾“å…¥');return;} await fetch('/api/add',{method:'POST',body:JSON.stringify({name:name,url:url})}); load();}" +

"async function del(i){ await fetch('/api/del?i='+i); load(); }" +

"load();" +
"</script></body></html>";

/* ===========================
      å…¬å…±çŠ¶æ€é¡µ (å«å¤œé—´æ¨¡å¼)
   =========================== */
const statusHTML =
"<!DOCTYPE html><html><head><meta charset='utf-8'><title>KeepURL çŠ¶æ€</title>" +
"<meta name='viewport' content='width=device-width, initial-scale=1'>" +
"<style>" +
"body{font-family:sans-serif;padding:20px;transition:0.3s;} " +
".dark{background:#111;color:#ddd;} " +
".card{border:1px solid #aaa;padding:10px;margin:8px 0;border-radius:6px;} " +
".ok{color:#4caf50;} .bad{color:#f44336;} " +
"</style></head><body>" +

"<button onclick='toggleDark()'>ğŸŒ™ å¤œé—´æ¨¡å¼</button>" +
"<h2>ğŸ“¡ KeepURL åœ¨çº¿ç›‘æ§</h2><p>æ¯ 30 ç§’è‡ªåŠ¨åˆ·æ–°</p>" +
"<div id='box'>åŠ è½½ä¸­â€¦</div>" +

"<script>" +
// å¤œé—´æ¨¡å¼
"if(localStorage.dark=='1') document.body.classList.add('dark');" +
"function toggleDark(){document.body.classList.toggle('dark');localStorage.dark=document.body.classList.contains('dark')?'1':'0';}" +

"async function loadStatus(){var r=await fetch('/api/status'); var j=await r.json(); var box=document.getElementById('box'); box.innerHTML='';" +
"j.forEach(function(x){ box.innerHTML += '<div class=\"card\"><b>'+x.name+'</b><br><small>'+x.url+'</small><br><span class=\"'+(x.ok?'ok':'bad')+'\">çŠ¶æ€ï¼š'+(x.ok?'æ­£å¸¸':'å¼‚å¸¸ ('+x.code+')')+'</span></div>'; });}" +

"loadStatus(); setInterval(loadStatus,30000);" +
"</script></body></html>";

/* ===========================
         Worker è·¯ç”±
   =========================== */
addEventListener("fetch", e => e.respondWith(handle(e.request)));

async function handle(req) {
    const u = new URL(req.url);

    if (u.pathname === "/")       return html(adminHTML);
    if (u.pathname === "/status") return html(statusHTML);

    if (u.pathname === "/api/list")
        return json(await loadList());

    if (u.pathname === "/api/add") {
        const body = await req.text();
        const data = JSON.parse(body || "{}");
        const list = await loadList();
        list.push({ name: data.name, url: data.url });
        await saveList(list);
        return json({ ok: true });
    }

    if (u.pathname === "/api/del") {
        const i = Number(u.searchParams.get("i"));
        const list = await loadList();
        list.splice(i, 1);
        await saveList(list);
        return json({ ok: true });
    }

    if (u.pathname === "/api/status") {
        const list = await loadList();
        const out = [];
        for (const x of list) {
            try {
                const r = await fetch(x.url);
                out.push({ name: x.name, url: x.url, ok: r.ok, code: r.status });
            } catch (e) {
                out.push({ name: x.name, url: x.url, ok: false, code: "ERR" });
            }
        }
        return json(out);
    }

    return new Response("Not Found", { status: 404 });
}

function html(s){ return new Response(s, { headers:{ "content-type":"text/html" } }); }
function json(o){ return new Response(JSON.stringify(o), { headers:{ "content-type":"application/json" } }); }

// å®šæ—¶æ£€æµ‹ + Telegram
addEventListener("scheduled", e => e.waitUntil(runCheck()));

async function runCheck() {
    const list = await loadList();
    for (const x of list) {
        try {
            const r = await fetch(x.url);
            if (!r.ok) {
                await tg("âŒ å¼‚å¸¸\n" + x.name + "\n" + x.url + "\nçŠ¶æ€ç ï¼š" + r.status);
            }
        } catch (e) {
            await tg("âŒ å¤±è´¥\n" + x.name + "\n" + x.url + "\né”™è¯¯ï¼š" + e);
        }
    }
}
